# Риски, зависимости и допущения (Web2RU)

## 1) Ключевые риски (и как их держать под контролем)
### 1.1 Рендер “стабильного” состояния страницы (Playwright)
**Риск:** networkidle часто не наступает; динамические страницы меняются бесконечно.  
**Митигируем:** фиксированная стратегия (DOMContentLoaded → wait → auto-scroll → wait → dump) + метрики в `report.json` (скролл‑шаги, изменение высоты).

### 1.2 Неполный офлайн‑снапшот ассетов
**Риск:** часть ресурсов не попадает в capture (lazy, media queries, hover), часть блокируется антиботом/CDN.  
**Митигируем:** двухэтапно: network capture + offline reference scan + fetch-missing (best effort), аккуратные лимиты размера/типа, и честный `missing_assets[]` в отчёте.

### 1.3 Shadow DOM
**Риск:** materialize работает только для **open** shadow roots; `adoptedStyleSheets` не всегда извлекается; Declarative Shadow DOM может отличаться между браузерами.  
**Митигируем:** best effort + отдельная статистика/ошибки в report; покрыть тестами, что `template[shadowrootmode]` участвует в extract/scan/rewrite.

### 1.4 DOM integrity при offline parse/serialize
**Риск:** HTML парсер может “нормализовать” документ (перестановка, auto-close tags, entity handling).  
**Митигируем:** выбрать один парсер и зафиксировать; тестировать на fixture HTML; запрещать любые операции, меняющие структуру узлов (только text/attrs).

### 1.5 Извлечение переводимого текста (Extract)
**Риск:** эвристики могут:
- захватывать лишнее (nav/footer),
- пропускать важное (основной контент),
- брать “технические токены” и ломать их переводом.  
**Митигируем:** scope main по приоритету (main/article/role=main/плотность текста), exclude-selector, Token Protector, регресс‑страницы.

### 1.6 LLM стабильность / structured outputs
**Риск:** даже со strict schema возможны incomplete, schema errors, пропажа id, порча плейсхолдеров.  
**Митигируем:** жёсткая валидация, retries, auto-split до минимального элемента, fallback на textnode, кэш переводов и запись ошибок в report.

### 1.7 Freeze-JS и офлайн безопасность
**Риск:** “перестараться” и сломать отображение (например, сайт полагается на JS для инъекции стилей), либо недожать и оставить внешние запросы.  
**Митигируем:** по умолчанию freeze-js=on + валидатор “0 external requests”; manual визуальный чек перед релизом.

### 1.8 Стоимость / скорость
**Риск:** большие страницы → много токенов/батчей, retries, долгий runtime.  
**Митигируем:** batching (chars + items), max_output_tokens, лимиты retries, кэш переводов, прогресс/метрики.

### 1.9 Правовые/этические моменты (не технические)
**Риск:** копирование и перевод контента может затрагивать авторские права даже при “персональном” использовании.  
**Митигируем:** явно позиционировать как персональный офлайн‑инструмент; не добавлять функции массового скрейпинга по умолчанию; при Phase 2 (crawl) — явный opt-in.

## 2) Зависимости (внешние)
- Playwright + Chromium (установка браузера обязательна).
- OpenAI API key (Responses API), доступность модели `gpt-5.1` по умолчанию.
- Сеть для online‑фазы и (опционально) fetch-missing.
- Кросс‑платформенность: macOS/Linux must, Windows best-effort.

## 3) Допущения (фиксируем явно)
- **HTML парсер (MVP):** используем `lxml.html` как дефолт для parse/traverse/serialize.
- **CSS rewrite (MVP):** используем `tinycss2` для `url()` и `@import`; regex-only подход не используем как основной.
- **CI:** live‑регрессия по реальным URL не является обязательным PR‑гейтом (слишком флейки); вместо этого PR‑гейт держим на фикстурах + локальной e2e.
- **Модели/параметры:** `reasoning-effort=medium` — дефолт, но в CLI разрешаем менять.
- **Модель по умолчанию (MVP):** `gpt-5.1` (по ТЗ), с обязательным override через `--model` и `WEB2RU_MODEL`.
- **Политика missing assets:** при недоступном ресурсе сохраняем офлайн‑чистоту (не оставляем внешние URL), даже если это ухудшает визуальную близость; фиксируем `missing_assets[]` в отчёте.
- **Режим `freeze-js=off`:** считается debug/unsafe; провал проверки “0 external requests” допустим и должен явно отражаться в `report.json`.
- **Критерий целостности HTML:** byte-identical не требуется; требуем структурную DOM-эквивалентность с разрешёнными изменениями (text nodes + allowlist attrs + freeze/sanitize правила).

Если допущение меняется — это отдельный PR с обновлением этого документа и `AGENTS.md`.
